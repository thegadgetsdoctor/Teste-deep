<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Portaria</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-gray: #f8f9fa;
            --dark-gray: #343a40;
            --success-color: #28a745;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        h1 {
            margin: 0;
            font-size: 2rem;
        }
        
        .tab {
            display: flex;
            background-color: white;
            border-radius: 5px 5px 0 0;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .tab button {
            flex: 1;
            background-color: inherit;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 12px 16px;
            transition: 0.3s;
            font-size: 1rem;
            font-weight: 600;
            color: var(--dark-gray);
        }
        
        .tab button:hover {
            background-color: #e9ecef;
        }
        
        .tab button.active {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .tabcontent {
            display: none;
            padding: 25px;
            background-color: white;
            border-radius: 0 0 5px 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            animation: fadeEffect 0.5s;
        }
        
        @keyframes fadeEffect {
            from {opacity: 0;}
            to {opacity: 1;}
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-gray);
        }
        
        input[type="text"], 
        input[type="number"],
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 1rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        
        input[type="text"]:focus, 
        input[type="number"]:focus,
        select:focus {
            border-color: var(--secondary-color);
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }
        
        .required-field::after {
            content: " *";
            color: var(--accent-color);
        }
        
        button {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #2186c4;
        }
        
        button.secondary {
            background-color: #6c757d;
        }
        
        button.secondary:hover {
            background-color: #5a6268;
        }
        
        button.success {
            background-color: var(--success-color);
        }
        
        button.success:hover {
            background-color: #218838;
        }
        
        button.danger {
            background-color: var(--accent-color);
        }
        
        button.danger:hover {
            background-color: #c0392b;
        }
        
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        .badge {
            display: inline-block;
            padding: 3px 7px;
            font-size: 0.8rem;
            font-weight: 700;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: middle;
            border-radius: 10px;
        }
        
        .badge-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .badge-warning {
            background-color: #ffc107;
            color: #212529;
        }
        
        .search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .search-container input {
            flex: 1;
        }
        
        .actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .visitor-card {
            background-color: white;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .visitor-card h3 {
            margin-top: 0;
            color: var(--primary-color);
        }
        
        .visitor-details {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .visitor-detail {
            margin-bottom: 5px;
        }
        
        .visitor-detail strong {
            display: block;
            color: var(--dark-gray);
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .tab {
                flex-direction: column;
            }
            
            .visitor-details {
                grid-template-columns: 1fr;
            }
            
            .actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Controle de Portaria</h1>
        </div>
    </header>
    
    <div class="container">
        <div class="tab">
            <button class="tablinks active" onclick="openTab(event, 'entrada')">Registrar Entrada</button>
            <button class="tablinks" onclick="openTab(event, 'saida')">Registrar Saída</button>
            <button class="tablinks" onclick="openTab(event, 'relatorio')">Relatório</button>
            <button class="tablinks" onclick="openTab(event, 'configuracoes')">Configurações</button>
        </div>

        <!-- Aba de Entrada -->
        <div id="entrada" class="tabcontent" style="display: block;">
            <h2>Registrar Entrada</h2>
            <form id="entrada-form" onsubmit="registrarEntrada(event)">
                <div class="form-group">
                    <label for="nome" class="required-field">Nome:</label>
                    <input type="text" id="nome" required autocomplete="off" placeholder="Nome completo do visitante">
                </div>
                <div class="form-group">
                    <label for="cpf">CPF:</label>
                    <input type="text" id="cpf" autocomplete="off" placeholder="000.000.000-00" oninput="formatarCPF(this)">
                </div>
                <div class="form-group">
                    <label for="placa">Placa do Veículo:</label>
                    <input type="text" id="placa" autocomplete="off" placeholder="ABC-1234" oninput="formatarPlaca(this)">
                </div>
                <div class="form-group">
                    <label for="motivo">Motivo da Visita:</label>
                    <select id="motivo">
                        <option value="Visita">Visita</option>
                        <option value="Entrega">Entrega</option>
                        <option value="Serviço">Serviço</option>
                        <option value="Reunião">Reunião</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="unidade" class="required-field">Unidade/Responsável:</label>
                    <input type="text" id="unidade" required autocomplete="off" placeholder="Departamento ou pessoa responsável">
                </div>
                <div class="form-group">
                    <label for="observacoes">Observações:</label>
                    <input type="text" id="observacoes" autocomplete="off" placeholder="Informações adicionais">
                </div>
                <div class="actions">
                    <button type="submit" class="success">Salvar Entrada</button>
                    <button type="reset" class="secondary">Limpar Formulário</button>
                </div>
            </form>
        </div>

        <!-- Aba de Saída -->
        <div id="saida" class="tabcontent">
            <h2>Registrar Saída</h2>
            <div class="search-container">
                <input type="text" id="buscaSaida" placeholder="Digite nome, CPF ou placa para buscar" autocomplete="off">
                <button onclick="buscarVisitante()" class="success">Buscar</button>
            </div>
            <div id="resultadoBusca" style="margin-top: 20px;"></div>
        </div>

        <!-- Aba de Relatório -->
        <div id="relatorio" class="tabcontent">
            <h2>Relatório de Visitas</h2>
            <div class="search-container">
                <input type="text" id="filtroRelatorio" placeholder="Filtrar por nome, CPF, placa ou motivo" oninput="filtrarRelatorio()">
                <select id="filtroStatus" onchange="filtrarRelatorio()">
                    <option value="todos">Todos</option>
                    <option value="aberto">Em andamento</option>
                    <option value="fechado">Finalizados</option>
                </select>
            </div>
            <div class="actions">
                <button onclick="exportarCSV()" class="secondary">Exportar para CSV</button>
                <button onclick="imprimirRelatorio()" class="secondary">Imprimir Relatório</button>
            </div>
            <div style="overflow-x: auto;">
                <table id="tabelaRelatorio">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>CPF</th>
                            <th>Placa</th>
                            <th>Entrada</th>
                            <th>Saída</th>
                            <th>Motivo</th>
                            <th>Unidade</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="corpoRelatorio"></tbody>
                </table>
            </div>
        </div>

        <!-- Aba de Configurações -->
        <div id="configuracoes" class="tabcontent">
            <h2>Configurações</h2>
            <div class="form-group">
                <label for="tempoSessao">Tempo de Sessão (minutos):</label>
                <input type="number" id="tempoSessao" min="1" value="30">
            </div>
            <div class="form-group">
                <label for="temaEscuro">Modo Escuro:</label>
                <input type="checkbox" id="temaEscuro" onchange="alternarTema()">
            </div>
            <div class="actions">
                <button onclick="salvarConfiguracoes()" class="success">Salvar Configurações</button>
                <button onclick="limparDados()" class="danger">Limpar Todos os Dados</button>
            </div>
            <div id="configAlert" style="margin-top: 20px;"></div>
        </div>
    </div>

    <script>
        // Banco de dados local
        let visitas = JSON.parse(localStorage.getItem('visitas')) || [];
        let configuracoes = JSON.parse(localStorage.getItem('configuracoes')) || {
            tempoSessao: 30,
            temaEscuro: false
        };

        // Inicializar configurações
        function inicializarConfiguracoes() {
            document.getElementById('tempoSessao').value = configuracoes.tempoSessao;
            document.getElementById('temaEscuro').checked = configuracoes.temaEscuro;
            alternarTema(configuracoes.temaEscuro);
        }

        // Alternar tema escuro/claro
        function alternarTema(ativar = null) {
            const temaEscuro = ativar !== null ? ativar : document.getElementById('temaEscuro').checked;
            if (temaEscuro) {
                document.body.classList.add('dark-theme');
            } else {
                document.body.classList.remove('dark-theme');
            }
        }

        // Salvar configurações
        function salvarConfiguracoes() {
            configuracoes = {
                tempoSessao: parseInt(document.getElementById('tempoSessao').value) || 30,
                temaEscuro: document.getElementById('temaEscuro').checked
            };
            
            localStorage.setItem('configuracoes', JSON.stringify(configuracoes));
            alternarTema();
            
            // Mostrar mensagem de sucesso
            const alertDiv = document.getElementById('configAlert');
            alertDiv.innerHTML = '<div class="alert alert-success">Configurações salvas com sucesso!</div>';
            setTimeout(() => {
                alertDiv.innerHTML = '';
            }, 3000);
        }

        // Limpar todos os dados
        function limparDados() {
            if (confirm('Tem certeza que deseja limpar TODOS os dados? Esta ação não pode ser desfeita.')) {
                localStorage.removeItem('visitas');
                localStorage.removeItem('configuracoes');
                visitas = [];
                configuracoes = {
                    tempoSessao: 30,
                    temaEscuro: false
                };
                inicializarConfiguracoes();
                atualizarRelatorio();
                alert('Todos os dados foram removidos com sucesso!');
            }
        }

        // Funções das abas
        function openTab(evt, tabName) {
            const tabcontent = document.getElementsByClassName("tabcontent");
            for (let i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            const tablinks = document.getElementsByClassName("tablinks");
            for (let i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
            
            // Atualizar relatório quando a aba for aberta
            if (tabName === 'relatorio') {
                atualizarRelatorio();
            }
        }

        // Formatar CPF
        function formatarCPF(campo) {
            let valor = campo.value.replace(/\D/g, '');
            
            if (valor.length > 3 && valor.length <= 6) {
                valor = valor.replace(/(\d{3})(\d{1,3})/, '$1.$2');
            } else if (valor.length > 6 && valor.length <= 9) {
                valor = valor.replace(/(\d{3})(\d{3})(\d{1,3})/, '$1.$2.$3');
            } else if (valor.length > 9) {
                valor = valor.replace(/(\d{3})(\d{3})(\d{3})(\d{1,2})/, '$1.$2.$3-$4');
            }
            
            campo.value = valor;
        }

        // Formatar placa de veículo
        function formatarPlaca(campo) {
            let valor = campo.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
            
            if (valor.length > 3) {
                valor = valor.replace(/([A-Z0-9]{3})([A-Z0-9]{1,4})/, '$1-$2');
            }
            
            campo.value = valor;
        }

        // Validar CPF
        function validarCPF(cpf) {
            cpf = cpf.replace(/\D/g, '');
            if (cpf.length === 0) return true; // CPF vazio é válido (não obrigatório)
            if (cpf.length !== 11) return false;
            
            // Verifica dígitos repetidos
            if (/^(\d)\1{10}$/.test(cpf)) return false;
            
            // Validação dos dígitos verificadores
            let soma = 0;
            for (let i = 0; i < 9; i++) {
                soma += parseInt(cpf.charAt(i)) * (10 - i);
            }
            let resto = 11 - (soma % 11);
            let digito1 = resto === 10 || resto === 11 ? 0 : resto;
            
            if (digito1 !== parseInt(cpf.charAt(9))) return false;
            
            soma = 0;
            for (let i = 0; i < 10; i++) {
                soma += parseInt(cpf.charAt(i)) * (11 - i);
            }
            resto = 11 - (soma % 11);
            let digito2 = resto === 10 || resto === 11 ? 0 : resto;
            
            return digito2 === parseInt(cpf.charAt(10));
        }

        // Registrar entrada
        function registrarEntrada(event) {
            event.preventDefault();
            
            const nome = document.getElementById('nome').value.trim();
            const cpf = document.getElementById('cpf').value.trim();
            const unidade = document.getElementById('unidade').value.trim();
            
            // Validações
            if (!nome || !unidade) {
                mostrarAlerta('Preencha os campos obrigatórios: Nome e Unidade/Responsável.', 'error');
                return;
            }
            
            if (cpf && !validarCPF(cpf)) {
                mostrarAlerta('CPF inválido. Por favor, corrija.', 'error');
                return;
            }
            
            const visita = {
                id: Date.now(), // ID único baseado no timestamp
                nome: nome,
                cpf: cpf,
                placa: document.getElementById('placa').value.trim(),
                motivo: document.getElementById('motivo').value,
                unidade: unidade,
                observacoes: document.getElementById('observacoes').value.trim(),
                entrada: new Date().toLocaleString('pt-BR'),
                saida: "",
                usuario: localStorage.getItem('usuario') || 'Portaria'
            };
            
            visitas.push(visita);
            localStorage.setItem('visitas', JSON.stringify(visitas));
            
            mostrarAlerta('Entrada registrada com sucesso!', 'success');
            document.getElementById('entrada-form').reset();
            atualizarRelatorio();
            
            // Focar no campo nome para nova entrada
            document.getElementById('nome').focus();
        }

        // Mostrar alerta
        function mostrarAlerta(mensagem, tipo) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${tipo}`;
            alertDiv.textContent = mensagem;
            
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Buscar visitante para saída
        function buscarVisitante() {
            const termo = document.getElementById('buscaSaida').value.toLowerCase();
            
            // Filtra visitas em aberto (sem data de saída)
            const resultados = visitas
                .map((v, idx) => ({...v, idx}))
                .filter(v => !v.saida && (
                    v.nome.toLowerCase().includes(termo) || 
                    v.cpf.replace(/\D/g, '').includes(termo.replace(/\D/g, '')) || 
                    v.placa.toLowerCase().includes(termo.toLowerCase())
                ));
            
            let html = '';
            if (resultados.length === 0) {
                html = '<div class="alert alert-error">Nenhuma visita em aberto encontrada.</div>';
            } else {
                resultados.forEach((visita) => {
                    html += `
                        <div class="visitor-card">
                            <h3>${visita.nome}</h3>
                            <div class="visitor-details">
                                <div class="visitor-detail">
                                    <strong>CPF</strong>
                                    ${visita.cpf || 'Não informado'}
                                </div>
                                <div class="visitor-detail">
                                    <strong>Placa</strong>
                                    ${visita.placa || 'Não informada'}
                                </div>
                                <div class="visitor-detail">
                                    <strong>Motivo</strong>
                                    ${visita.motivo}
                                </div>
                                <div class="visitor-detail">
                                    <strong>Unidade</strong>
                                    ${visita.unidade}
                                </div>
                                <div class="visitor-detail">
                                    <strong>Entrada</strong>
                                    ${visita.entrada}
                                </div>
                            </div>
                            <button onclick="registrarSaida(${visita.idx})" class="danger">Registrar Saída</button>
                        </div>
                    `;
                });
            }
            document.getElementById('resultadoBusca').innerHTML = html;
        }

        // Registrar saída
        function registrarSaida(index) {
            if (visitas[index]) {
                visitas[index].saida = new Date().toLocaleString('pt-BR');
                visitas[index].usuarioSaida = localStorage.getItem('usuario') || 'Portaria';
                localStorage.setItem('visitas', JSON.stringify(visitas));
                
                mostrarAlerta('Saída registrada com sucesso!', 'success');
                buscarVisitante();
                atualizarRelatorio();
                
                // Limpar campo de busca
                document.getElementById('buscaSaida').value = '';
            }
        }

        // Filtrar relatório
        function filtrarRelatorio() {
            const termo = document.getElementById('filtroRelatorio').value.toLowerCase();
            const status = document.getElementById('filtroStatus').value;
            
            const corpo = document.getElementById('corpoRelatorio');
            corpo.innerHTML = '';
            
            visitas
                .filter(v => {
                    // Filtro por termo de busca
                    const matchTermo = 
                        v.nome.toLowerCase().includes(termo) || 
                        (v.cpf && v.cpf.includes(termo)) || 
                        (v.placa && v.placa.toLowerCase().includes(termo)) || 
                        v.motivo.toLowerCase().includes(termo);
                    
                    // Filtro por status
                    const matchStatus = 
                        status === 'todos' || 
                        (status === 'aberto' && !v.saida) || 
                        (status === 'fechado' && v.saida);
                    
                    return matchTermo && matchStatus;
                })
                .forEach(visita => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${visita.nome}</td>
                        <td>${visita.cpf || '-'}</td>
                        <td>${visita.placa || '-'}</td>
                        <td>${visita.entrada}</td>
                        <td>${visita.saida || '-'}</td>
                        <td>${visita.motivo}</td>
                        <td>${visita.unidade}</td>
                        <td>
                            ${visita.saida ? 
                                '<span class="badge badge-success">Finalizado</span>' : 
                                '<span class="badge badge-warning">Em andamento</span>'}
                        </td>
                    `;
                    corpo.appendChild(row);
                });
        }

        // Atualizar relatório
        function atualizarRelatorio() {
            filtrarRelatorio();
        }

        // Exportar para CSV
        function exportarCSV() {
            let csv = 'Nome,CPF,Placa,Entrada,Saída,Motivo,Unidade,Status,Observações\n';
            
            visitas.forEach(visita => {
                const status = visita.saida ? 'Finalizado' : 'Em andamento';
                csv += `"${visita.nme}","${visita.cpf || ''}","${visita.placa || ''}",` +
                      `"${visita.entrada}","${visita.saida || ''}","${visita.motivo}",` +
                      `"${visita.unidade}","${status}","${visita.observacoes || ''}"\n`;
            });

            const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', `visitas_portaria_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // Imprimir relatório
        function imprimirRelatorio() {
            const tabelaOriginal = document.getElementById('tabelaRelatorio');
            const clone = tabelaOriginal.cloneNode(true);
            
            // Remover colunas não necessárias para impressão
            const colunasParaRemover = [7]; // Índice da coluna de status
            clone.querySelectorAll('tr').forEach(linha => {
                colunasParaRemover.forEach(indice => {
                    if (linha.cells[indice]) linha.cells[indice].remove();
                });
            });
            
            const janelaImpressao = window.open('', '_blank');
            janelaImpressao.document.write(`
                <html>
                    <head>
                        <title>Relatório de Visitas</title>
                        <style>
                            body { font-family: Arial, sans-serif; }
                            table { width: 100%; border-collapse: collapse; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                            th { background-color: #f2f2f2; }
                            h1 { text-align: center; }
                            .no-print { display: none; }
                        </style>
                    </head>
                    <body>
                        <h1>Relatório de Visitas</h1>
                        <p>Emitido em: ${new Date().toLocaleString('pt-BR')}</p>
                        ${clone.outerHTML}
                        <script>
                            window.onload = function() {
                                window.print();
                                setTimeout(function() {
                                    window.close();
                                }, 100);
                            };
                        <\/script>
                    </body>
                </html>
            `);
            janelaImpressao.document.close();
        }

        // Inicializar
        window.onload = function() {
            inicializarConfiguracoes();
            atualizarRelatorio();
            
            // Foco no campo de busca ao abrir a aba de saída
            document.querySelectorAll('.tablinks').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    if (this.textContent.includes('Saída')) {
                        setTimeout(() => {
                            document.getElementById('buscaSaida').focus();
                        }, 100);
                    } else if (this.textContent.includes('Entrada')) {
                        setTimeout(() => {
                            document.getElementById('nome').focus();
                        }, 100);
                    }
                });
            });
            
            // Configurar timeout de sessão
            if (configuracoes.tempoSessao) {
                setTimeout(() => {
                    alert('Sessão expirada. Por favor, faça login novamente.');
                    // Aqui você pode redirecionar para uma página de login se necessário
                }, configuracoes.tempoSessao * 60 * 1000);
            }
        };
    </script>
</body>
</html>
