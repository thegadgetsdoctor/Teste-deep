<!DOCTYPE html>
<html>
<head>
    <title>Controle de Portaria</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; background: #f8f9fa; }
        .container { max-width: 700px; margin: 30px auto; background: #fff; border-radius: 10px; box-shadow: 0 2px 12px #0001; padding: 30px; }
        h1 { text-align: center; color: #2c3e50; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #e0e0e0; padding: 10px; text-align: left; }
        th { background-color: #e9ecef; color: #34495e; }
        tr:nth-child(even) { background: #f6f6f6; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #34495e; font-weight: 500; }
        input[type="text"], select { width: 100%; padding: 8px 10px; border: 1px solid #bfc9d1; border-radius: 5px; font-size: 1em; transition: border 0.2s; }
        input[type="text"]:focus, select:focus { border: 1.5px solid #007bff; outline: none; }
        button { padding: 10px 18px; background: #007bff; color: #fff; border: none; border-radius: 5px; font-size: 1em; transition: background 0.2s; }
        button:hover { background: #0056b3; }
        .tab { overflow: hidden; border-radius: 8px 8px 0 0; border: 1px solid #ccc; background-color: #e9ecef; margin-bottom: 0; }
        .tab button { background-color: inherit; border: none; outline: none; cursor: pointer; padding: 12px 20px; font-size: 1em; color: #34495e; transition: background 0.2s, color 0.2s; }
        .tab button.active, .tab button:hover { background-color: #007bff; color: #fff; }
        .tabcontent { display: none; padding: 25px 0 0 0; }
        @media (max-width: 600px) {
            .container { padding: 10px; }
            table, th, td { font-size: 0.95em; }
        }
        .error-msg { color: #c0392b; margin-bottom: 10px; font-weight: 500; }
        .success-msg { color: #27ae60; margin-bottom: 10px; font-weight: 500; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Controle de Portaria</h1>
        <div class="tab">
            <button class="tablinks active" onclick="openTab(event, 'entrada')">Registrar Entrada</button>
            <button class="tablinks" onclick="openTab(event, 'saida')">Registrar Saída</button>
            <button class="tablinks" onclick="openTab(event, 'relatorio')">Relatório</button>
        </div>

        <!-- Aba de Entrada -->
        <div id="entrada" class="tabcontent" style="display: block;">
            <h2>Registrar Entrada</h2>
            <div id="msgEntrada"></div>
            <form id="entrada-form" autocomplete="off" onsubmit="registrarEntrada(event)">
                <div class="form-group">
                    <label for="nome">Nome:<span style="color:#c0392b">*</span></label>
                    <input type="text" id="nome" required maxlength="60">
                </div>
                <div class="form-group">
                    <label for="cpf">CPF:<span style="color:#c0392b">*</span></label>
                    <input type="text" id="cpf" required maxlength="14" oninput="mascaraCPF(this)">
                </div>
                <div class="form-group">
                    <label for="placa">Placa do Veículo (opcional):</label>
                    <input type="text" id="placa" maxlength="8" oninput="mascaraPlaca(this)">
                </div>
                <div class="form-group">
                    <label for="motivo">Motivo:</label>
                    <select id="motivo">
                        <option value="Visita">Visita</option>
                        <option value="Entrega">Entrega</option>
                        <option value="Serviço">Serviço</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="unidade">Unidade/Responsável:<span style="color:#c0392b">*</span></label>
                    <input type="text" id="unidade" required maxlength="60">
                </div>
                <button type="submit">Salvar Entrada</button>
            </form>
        </div>

        <!-- Aba de Saída -->
        <div id="saida" class="tabcontent">
            <h2>Registrar Saída</h2>
            <div class="form-group">
                <label for="buscaSaida">CPF ou Nome:</label>
                <input type="text" id="buscaSaida" placeholder="Digite para buscar">
            </div>
            <button onclick="buscarVisitante()">Buscar</button>
            <div id="resultadoBusca" style="margin-top: 20px;"></div>
        </div>

        <!-- Aba de Relatório -->
        <div id="relatorio" class="tabcontent">
            <h2>Relatório de Visitas</h2>
            <button onclick="exportarCSV()">Exportar para CSV</button>
            <table id="tabelaRelatorio">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>CPF</th>
                        <th>Placa</th>
                        <th>Entrada</th>
                        <th>Saída</th>
                        <th>Motivo</th>
                        <th>Unidade</th>
                    </tr>
                </thead>
                <tbody id="corpoRelatorio"></tbody>
            </table>
        </div>
    </div>

    <script>
        // Banco de dados local
        let visitas = JSON.parse(localStorage.getItem('visitas')) || [];

        // Funções das abas
        function openTab(evt, tabName) {
            const tabcontent = document.getElementsByClassName("tabcontent");
            for (let i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            const tablinks = document.getElementsByClassName("tablinks");
            for (let i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        // Máscara para CPF
        function mascaraCPF(input) {
            let v = input.value.replace(/\D/g, "");
            if (v.length > 11) v = v.slice(0, 11);
            v = v.replace(/(\d{3})(\d)/, "$1.$2");
            v = v.replace(/(\d{3})(\d)/, "$1.$2");
            v = v.replace(/(\d{3})(\d{1,2})$/, "$1-$2");
            input.value = v;
        }

        // Máscara para placa (formato ABC-1234 ou ABC1D23)
        function mascaraPlaca(input) {
            let v = input.value.toUpperCase().replace(/[^A-Z0-9]/g, "");
            if (v.length > 7) v = v.slice(0, 7);
            if (v.length > 3 && v[3].match(/\d/)) {
                // Mercosul: ABC1D23
                input.value = v;
            } else if (v.length > 3) {
                input.value = v.slice(0, 3) + '-' + v.slice(3);
            } else {
                input.value = v;
            }
        }

        // Validação simples de CPF
        function validarCPF(cpf) {
            cpf = cpf.replace(/\D/g, "");
            if (cpf.length !== 11 || /^([0-9])\1+$/.test(cpf)) return false;
            let soma = 0, resto;
            for (let i = 1; i <= 9; i++) soma += parseInt(cpf.substring(i-1, i)) * (11 - i);
            resto = (soma * 10) % 11;
            if (resto === 10 || resto === 11) resto = 0;
            if (resto !== parseInt(cpf.substring(9, 10))) return false;
            soma = 0;
            for (let i = 1; i <= 10; i++) soma += parseInt(cpf.substring(i-1, i)) * (12 - i);
            resto = (soma * 10) % 11;
            if (resto === 10 || resto === 11) resto = 0;
            if (resto !== parseInt(cpf.substring(10, 11))) return false;
            return true;
        }

        // Registrar entrada
        function registrarEntrada(event) {
            event.preventDefault();
            const nome = document.getElementById('nome').value.trim();
            const cpf = document.getElementById('cpf').value.trim();
            const placa = document.getElementById('placa').value.trim();
            const motivo = document.getElementById('motivo').value;
            const unidade = document.getElementById('unidade').value.trim();
            const msgDiv = document.getElementById('msgEntrada');
            msgDiv.innerHTML = '';

            // Validação
            if (!nome || !cpf || !unidade) {
                msgDiv.innerHTML = '<div class="error-msg">Preencha todos os campos obrigatórios.</div>';
                return;
            }
            if (!validarCPF(cpf)) {
                msgDiv.innerHTML = '<div class="error-msg">CPF inválido.</div>';
                return;
            }
            // Prevenir duplicidade (mesmo nome e CPF sem saída)
            const duplicado = visitas.some(v => v.cpf.replace(/\D/g,"") === cpf.replace(/\D/g,"") && !v.saida);
            if (duplicado) {
                msgDiv.innerHTML = '<div class="error-msg">Já existe uma entrada em aberto para este CPF.</div>';
                return;
            }

            const visita = {
                nome,
                cpf,
                placa,
                motivo,
                unidade,
                entrada: new Date().toLocaleString(),
                saida: ""
            };

            visitas.push(visita);
            localStorage.setItem('visitas', JSON.stringify(visitas));
            msgDiv.innerHTML = '<div class="success-msg">Entrada registrada com sucesso!</div>';
            document.getElementById('entrada-form').reset();
            atualizarRelatorio();
        }

        // Buscar visitante para saída
        function buscarVisitante() {
            const termo = document.getElementById('buscaSaida').value.trim().toLowerCase();
            const resultados = visitas
                .map((v, idx) => ({...v, _idx: idx}))
                .filter(v => !v.saida && (v.nome.toLowerCase().includes(termo) || v.cpf.replace(/\D/g,"").includes(termo.replace(/\D/g, ""))));

            let html = '';
            if (resultados.length === 0) {
                html = '<p>Nenhuma visita em aberto encontrada.</p>';
            } else {
                html = '<table><tr><th>Nome</th><th>Entrada</th><th>Ação</th></tr>';
                resultados.forEach((visita) => {
                    html += `
                        <tr>
                            <td>${visita.nome}</td>
                            <td>${visita.entrada}</td>
                            <td><button onclick="registrarSaida(${visita._idx})">Registrar Saída</button></td>
                        </tr>
                    `;
                });
                html += '</table>';
            }
            document.getElementById('resultadoBusca').innerHTML = html;
        }

        // Registrar saída
        function registrarSaida(idx) {
            visitas[idx].saida = new Date().toLocaleString();
            localStorage.setItem('visitas', JSON.stringify(visitas));
            alert('Saída registrada com sucesso!');
            buscarVisitante();
            atualizarRelatorio();
        }

        // Atualizar relatório
        function atualizarRelatorio() {
            const corpo = document.getElementById('corpoRelatorio');
            corpo.innerHTML = '';
            visitas.forEach(visita => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${visita.nome}</td>
                    <td>${visita.cpf}</td>
                    <td>${visita.placa}</td>
                    <td>${visita.entrada}</td>
                    <td>${visita.saida || 'Em andamento'}</td>
                    <td>${visita.motivo}</td>
                    <td>${visita.unidade}</td>
                `;
                corpo.appendChild(row);
            });
        }

        // Exportar para CSV
        function exportarCSV() {
            let csv = 'Nome,CPF,Placa,Entrada,Saída,Motivo,Unidade\n';
            visitas.forEach(visita => {
                csv += `"${visita.nome}","${visita.cpf}","${visita.placa}","${visita.entrada}","${visita.saida}","${visita.motivo}","${visita.unidade}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', 'visitas_portaria.csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // Inicializar
        window.onload = atualizarRelatorio;
    </script>
</body>
</html>
