<!DOCTYPE html>
<html>
<head>
    <title>Controle de Portaria</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1>Controle de Portaria</h1>
    <div class="container">
        <div id="login-area" class="auth-area" style="display:none;">
            <h2 class="auth-title">Login</h2>
            <form id="login-form" onsubmit="login(event)">
                <div class="form-group">
                    <label for="login-usuario">Usuário:</label>
                    <input type="text" id="login-usuario" required autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="login-senha">Senha:</label>
                    <input type="password" id="login-senha" required autocomplete="off">
                </div>
                <button type="submit">Entrar</button>
            </form>
            <div id="login-msg" class="msg"></div>
            <p style="margin-top:18px;">Não tem conta? <a href="#" onclick="mostrarRegistro()">Registre-se</a></p>
        </div>
        <div id="registro-area" class="auth-area" style="display:none;">
            <h2 class="auth-title">Registrar Usuário</h2>
            <form id="registro-form" onsubmit="registrarUsuario(event)">
                <div class="form-group">
                    <label for="reg-usuario">Usuário:</label>
                    <input type="text" id="reg-usuario" required autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="reg-senha">Senha:</label>
                    <input type="password" id="reg-senha" required autocomplete="off">
                </div>
                <button type="submit">Registrar</button>
                <button type="button" class="btn-voltar" onclick="mostrarLogin()">Voltar</button>
            </form>
            <div id="registro-msg" class="msg"></div>
        </div>
        <div id="sistema-area" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; flex-wrap:wrap; gap:10px;">
                <div class="tab">
                    <button class="tablinks active" onclick="openTab(event, 'entrada')">Registrar Entrada</button>
                    <button class="tablinks" onclick="openTab(event, 'saida')">Registrar Saída</button>
                    <button class="tablinks" onclick="openTab(event, 'relatorio')">Relatório</button>
                </div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <span id="usuario-logado" style="color:#357ae8; font-weight:600;"></span>
                    <button onclick="logout()" class="btn-voltar">Sair</button>
                </div>
            </div>
            <!-- Aba de Entrada -->
            <div id="entrada" class="tabcontent" style="display: block;">
                <h2 style="margin-bottom:18px; color:#357ae8;">Registrar Entrada</h2>
                <form id="entrada-form" onsubmit="registrarEntrada(event)">
                    <div class="form-group">
                        <label for="nome">Nome:<span style="color:red">*</span></label>
                        <input type="text" id="nome" required autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="cpf">CPF:</label>
                        <input type="text" id="cpf" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="placa">Placa do Veículo (opcional):</label>
                        <input type="text" id="placa" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="motivo">Motivo:</label>
                        <select id="motivo">
                            <option value="Visita">Visita</option>
                            <option value="Entrega">Entrega</option>
                            <option value="Serviço">Serviço</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="unidade">Unidade/Responsável:<span style="color:red">*</span></label>
                        <input type="text" id="unidade" required autocomplete="off">
                    </div>
                    <button type="submit">Salvar Entrada</button>
                </form>
            </div>
            <!-- Aba de Saída -->
            <div id="saida" class="tabcontent">
                <h2 style="margin-bottom:18px; color:#357ae8;">Registrar Saída</h2>
                <div class="form-group">
                    <label for="buscaSaida">CPF ou Nome:</label>
                    <input type="text" id="buscaSaida" placeholder="Digite para buscar">
                </div>
                <button onclick="buscarVisitante()">Buscar</button>
                <div id="resultadoBusca" style="margin-top: 20px;"></div>
            </div>
            <!-- Aba de Relatório -->
            <div id="relatorio" class="tabcontent">
                <h2 style="margin-bottom:18px; color:#357ae8;">Relatório de Visitas</h2>
                <button class="csv-btn" onclick="exportarCSV()">Exportar para CSV</button>
                <div style="clear:both"></div>
                <table id="tabelaRelatorio">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>CPF</th>
                            <th>Placa</th>
                            <th>Entrada</th>
                            <th>Saída</th>
                            <th>Motivo</th>
                            <th>Unidade</th>
                        </tr>
                    </thead>
                    <tbody id="corpoRelatorio"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Banco de dados local
        let visitas = JSON.parse(localStorage.getItem('visitas')) || [];

        // Usuários (login)
        function getUsuarios() {
            return JSON.parse(localStorage.getItem('usuarios')) || [];
        }
        function setUsuarios(usuarios) {
            localStorage.setItem('usuarios', JSON.stringify(usuarios));
        }
        // Reseta usuários e cria apenas admin/admin
        function resetarUsuariosAdmin() {
            const admin = [{ usuario: 'admin', senha: 'admin' }];
            setUsuarios(admin);
        }

        // Controle de sessão
        function setUsuarioLogado(usuario) {
            localStorage.setItem('usuarioLogado', usuario);
        }
        function getUsuarioLogado() {
            return localStorage.getItem('usuarioLogado');
        }
        function logout() {
            localStorage.removeItem('usuarioLogado');
            mostrarLogin();
        }

        // Exibição de áreas
        function mostrarLogin() {
            document.getElementById('login-area').style.display = '';
            document.getElementById('registro-area').style.display = 'none';
            document.getElementById('sistema-area').style.display = 'none';
            document.getElementById('login-form').reset();
            document.getElementById('login-msg').innerHTML = '';
        }
        function mostrarRegistro() {
            document.getElementById('login-area').style.display = 'none';
            document.getElementById('registro-area').style.display = '';
            document.getElementById('sistema-area').style.display = 'none';
            document.getElementById('registro-form').reset();
            document.getElementById('registro-msg').innerHTML = '';
        }
        function mostrarSistema() {
            document.getElementById('login-area').style.display = 'none';
            document.getElementById('registro-area').style.display = 'none';
            document.getElementById('sistema-area').style.display = '';
            atualizarRelatorio();
            // Exibe usuário logado
            const usuario = getUsuarioLogado();
            document.getElementById('usuario-logado').textContent = usuario ? `Usuário: ${usuario}` : '';
        }

        // Login
        function login(event) {
            event.preventDefault();
            const usuario = document.getElementById('login-usuario').value.trim();
            const senha = document.getElementById('login-senha').value;
            const usuarios = getUsuarios();
            const user = usuarios.find(u => u.usuario === usuario && u.senha === senha);
            const msgDiv = document.getElementById('login-msg');
            msgDiv.innerHTML = '';
            if (user) {
                setUsuarioLogado(usuario);
                mostrarSistema();
            } else {
                msgDiv.innerHTML = '<span class="msg-erro">Usuário ou senha inválidos!</span>';
            }
        }

        // Registro
        function registrarUsuario(event) {
            event.preventDefault();
            const usuario = document.getElementById('reg-usuario').value.trim();
            const senha = document.getElementById('reg-senha').value;
            const msgDiv = document.getElementById('registro-msg');
            msgDiv.innerHTML = '';
            if (!usuario || !senha) {
                msgDiv.innerHTML = '<span class="msg-erro">Preencha todos os campos!</span>';
                return;
            }
            let usuarios = getUsuarios();
            if (usuarios.find(u => u.usuario === usuario)) {
                msgDiv.innerHTML = '<span class="msg-erro">Usuário já existe!</span>';
                return;
            }
            usuarios.push({ usuario, senha });
            setUsuarios(usuarios);
            msgDiv.innerHTML = '<span class="msg-sucesso">Usuário registrado com sucesso! Faça login.</span>';
            setTimeout(() => { mostrarLogin(); }, 1200);
        }

        // Funções das abas
        function openTab(evt, tabName) {
            const tabcontent = document.getElementsByClassName("tabcontent");
            for (let i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            const tablinks = document.getElementsByClassName("tablinks");
            for (let i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        // Registrar entrada
        function registrarEntrada(event) {
            if (event) event.preventDefault();
            const nome = document.getElementById('nome').value.trim();
            const unidade = document.getElementById('unidade').value.trim();
            if (!nome || !unidade) {
                alert('Preencha os campos obrigatórios: Nome e Unidade/Responsável.');
                return;
            }
            const visita = {
                nome: nome,
                cpf: document.getElementById('cpf').value.trim(),
                placa: document.getElementById('placa').value.trim(),
                motivo: document.getElementById('motivo').value,
                unidade: unidade,
                entrada: new Date().toLocaleString(),
                saida: ""
            };
            visitas.push(visita);
            localStorage.setItem('visitas', JSON.stringify(visitas));
            alert('Entrada registrada com sucesso!');
            document.getElementById('entrada-form').reset();
            atualizarRelatorio();
        }

        // Buscar visitante para saída
        function buscarVisitante() {
            const termo = document.getElementById('buscaSaida').value.toLowerCase();
            // Filtra e armazena o índice real de cada visita
            const resultados = visitas
                .map((v, idx) => ({...v, idx}))
                .filter(v => !v.saida && (v.nome.toLowerCase().includes(termo) || v.cpf.includes(termo)));

            let html = '';
            if (resultados.length === 0) {
                html = '<p>Nenhuma visita em aberto encontrada.</p>';
            } else {
                html = '<table><tr><th>Nome</th><th>Entrada</th><th>Ação</th></tr>';
                resultados.forEach((visita) => {
                    html += `
                        <tr>
                            <td>${visita.nome}</td>
                            <td>${visita.entrada}</td>
                            <td><button onclick="registrarSaida(${visita.idx})">Registrar Saída</button></td>
                        </tr>
                    `;
                });
                html += '</table>';
            }
            document.getElementById('resultadoBusca').innerHTML = html;
        }

        // Registrar saída
        function registrarSaida(index) {
            if (visitas[index]) {
                visitas[index].saida = new Date().toLocaleString();
                localStorage.setItem('visitas', JSON.stringify(visitas));
                alert('Saída registrada com sucesso!');
                buscarVisitante();
                atualizarRelatorio();
            }
        }

        // Atualizar relatório
        function atualizarRelatorio() {
            const corpo = document.getElementById('corpoRelatorio');
            corpo.innerHTML = '';
            visitas.forEach(visita => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${visita.nome}</td>
                    <td>${visita.cpf}</td>
                    <td>${visita.placa}</td>
                    <td>${visita.entrada}</td>
                    <td>${visita.saida || 'Em andamento'}</td>
                    <td>${visita.motivo}</td>
                    <td>${visita.unidade}</td>
                `;
                corpo.appendChild(row);
            });
        }

        // Exportar para CSV
        function exportarCSV() {
            let csv = 'Nome,CPF,Placa,Entrada,Saída,Motivo,Unidade\n';
            visitas.forEach(visita => {
                csv += `"${visita.nome}","${visita.cpf}","${visita.placa}","${visita.entrada}","${visita.saida}","${visita.motivo}","${visita.unidade}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', 'visitas_portaria.csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // Inicializar
        window.onload = function() {
            resetarUsuariosAdmin();
            localStorage.removeItem('usuarioLogado');
            if (getUsuarioLogado()) {
                mostrarSistema();
            } else {
                mostrarLogin();
            }
            // Foco no campo de busca ao abrir a aba de saída
            document.querySelectorAll('.tablinks').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    if (this.textContent.includes('Saída')) {
                        setTimeout(() => {
                            document.getElementById('buscaSaida').focus();
                        }, 100);
                    }
                });
            });
        };
    </script>
</body>
</html>
